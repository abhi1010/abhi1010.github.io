<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Coders Digest &middot; Abhishek Pandey</title>

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="http://abhipandey.com/css/poole.css?ref=abc124">
  <link rel="stylesheet" href="http://abhipandey.com/css/hyde.css?ref=abc124">
  <link rel="stylesheet" href="http://abhipandey.com/css/poole-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://abhipandey.com/css/hyde-overrides.css?ref=abc124">
  <link rel="stylesheet" href="http://abhipandey.com/css/hyde-a.css?ref=abc124">
  <link rel="stylesheet" href="http://abhipandey.com/css/custom-additions.css?ref=abc124">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://abhipandey.com/touch-icon-144-precomposed.png?ref=abc124">
  <link href="http://abhipandey.com/favicon.png?ref=abc124" rel="icon">

  
  
  
  <link href="http://abhipandey.com/index.xml" rel="alternate" type="application/rss+xml" title="Coders Digest &middot; Abhishek Pandey" />

  <meta name="description" content="C&#43;&#43;/python/bash code; How to automate and deploy your applications">
  <meta name="keywords" content="aws,deploy,elastic beanstalk,beanstalk,python,c&#43;&#43;,continuous delivery,tips,code,docker,bash,linux">
  
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68135443-1', 'auto');
      ga('send', 'pageview');
  </script>

</head>
<body class="theme-base-aa">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1><a href="http://abhipandey.com/">Coder&rsquo;s Digest</a></h1>
      <a href="http://abhipandey.com/"><p>Abhishek Pandey</p></a>
    </div>

    <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a href="http://abhipandey.com/post/">Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="http://abhipandey.com/tags/">Tags</a></li>
      
      <li class="sidebar-nav-item"><a href="http://abhipandey.com/categories/">Categories</a></li>
      
      <li class="sidebar-nav-item"><a href="http://abhipandey.com/about/">About</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      
      
      
      
      
      
      
      
      </li>
    </ul>

    

  </div>
</div>


<div class="content container">
  <div class="posts">
    
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2015/09/elastic-beanstalk-deployment-automation/">Elastic Beanstalk Deployment Automation</a>
      </h1>
      <span class="post-date">Sep 4, 2015  &middot; <a href="http://abhipandey.com/2015/09/elastic-beanstalk-deployment-automation/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/continuous-delivery">continuous delivery</a><a class="a_cat" href="http://abhipandey.com/categories/code">code</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/aws">aws</a><a class="a_tag" href="http://abhipandey.com/tags/beanstalk">beanstalk</a><a class="a_tag" href="http://abhipandey.com/tags/deployment">deployment</a><a class="a_tag" href="http://abhipandey.com/tags/docker">docker</a><a class="a_tag" href="http://abhipandey.com/tags/python">python</a><a class="a_tag" href="http://abhipandey.com/tags/supervisord">supervisord</a>
    
      </span>
      
      

<p>We are going to talk about a setup where <strong>all you need to do it <em>commit</em> your code and all the rest of the steps from unit tests to deployment can be taken care of by some externally hosted cloud platform that provides continuous integration.</strong>
  In my case, it is going to be <code>Shippable</code> that I am using as a sample but you can use almost anything like <code>TravisCI</code> or <code>codeship</code>, for example.</p>

<h1 id="setup:8d5fa5afd262889ee9af2f0243a94c6d">Setup</h1>

<p>Here is the setup we will be looking at:</p>


<figure >
    
        <img src="/images/elastic-beanstalk-deployment-automation-arch.png" alt="Architecture" />
    
    
    <figcaption>
        <p>
        Architecture
        
            
        
        </p> 
    </figcaption>
    
</figure>


<h1 id="shippable-for-commits:8d5fa5afd262889ee9af2f0243a94c6d">Shippable for commits</h1>

<p>We will use <code>shippable</code> for the following:</p>

<ul>
<li>Unit Tests</li>
<li>Regression Tests</li>
<li>Localized DB Tests</li>
<li>Tagging of the source code if the commit passes all tests</li>
<li>Deployment of the source code on <code>beanstalk</code> running <code>docker</code></li>
</ul>

<p>Login onto <code>shippable</code> and setup your project to be built. It uses webhooks with your repository like <code>GitHub</code> or <code>shippable</code> which are called on every commit.
You can create a <code>shippable.yml</code> file in your project which will be called on every commit. If you have used <code>docker</code> before, it might look familiar because they invoke a <code>docker</code> script to run the script within <code>shippable.yml</code></p>

<p>Here is one of my sample files from the project that powers this blog:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">language: python

install:
  - pip install Pygments 

before_script:
  - git config --global push.default matching
  - mkdir -p themes
  - git clone git@github.com:abhi1010/abhi1010.github.io.git
  - <span style="color: #204a87">cd</span> themes
  - git clone https://github.com/abhi1010/hyde-a.git
  - <span style="color: #204a87">cd</span> ../

script:
  - hugo -d abhi1010.github.io/

after_success:
  - <span style="color: #204a87">echo</span> <span style="color: #4e9a06">`</span><span style="color: #204a87">pwd</span><span style="color: #4e9a06">`</span>
  - <span style="color: #204a87">export</span> <span style="color: #000000">NOW_HOUR</span><span style="color: #ce5c00; font-weight: bold">=</span><span style="color: #204a87; font-weight: bold">$(</span>date +%d-%b-%H_%M<span style="color: #204a87; font-weight: bold">)</span> 
  - git config --global user.email <span style="color: #4e9a06">&quot;abhi.pandey@gmail.com&quot;</span>
  - git config --global user.name <span style="color: #4e9a06">&quot;abhi1010&quot;</span>
  - git config --get remote.origin.url
  - git remote set-url origin git@github.com:abhi1010.github.io.git
  - <span style="color: #204a87">cd</span> abhi1010.github.io
  - git status -s
  - <span style="color: #204a87">echo</span> -e <span style="color: #4e9a06">&quot;a\n*\nq\n&quot;</span><span style="color: #000000; font-weight: bold">|</span>git add -i
  - git commit -am <span style="color: #4e9a06">&#39;Automated build from Shippable - &#39;</span>$NOW_HOUR <span style="color: #ce5c00; font-weight: bold">&amp;&amp;</span> git push


notifications:
     email:
         recipients:
             - abhi@boun.cr
         on_success: change
         on_failure: always

cache: <span style="color: #204a87">true</span>
</pre></div>


<p>This script does the following tasks:</p>

<ul>
<li>Set <code>python</code> as the default language for the scripts to use</li>
<li>Install <code>Pygments</code> using <code>pip</code></li>
<li>My blog is done using three repos - so it does a <em>git clone</em> for each</li>
<li>Calls on hugo to create the static site</li>
<li>Commits the changes made in static content to <code>GitHub</code></li>
</ul>

<p>Once it works, you will see the following on <code>shippable</code> site:</p>


<figure >
    
        <img src="/images/elastic-beanstalk-deployment-automation-2.png" alt="Shippable Build Status" />
    
    
    <figcaption>
        <p>
        Shippable Build Status
        
            
        
        </p> 
    </figcaption>
    
</figure>


<h2 id="unit-tests:8d5fa5afd262889ee9af2f0243a94c6d">Unit Tests</h2>

<p>You may also want to set up unit tests and regression tests as part of your <em>scripts</em>
Just do the following then</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000000">script</span><span style="color: #000000; font-weight: bold">:</span>
  <span style="color: #000000; font-weight: bold">-</span>  <span style="color: #000000">py.test-3.4 tests/test.py --maxfail=3 -s --full-trace --tb=long --junitxml=../shippable/testresults/pytests.xml</span>
</pre></div>


<h2 id="git-tagging:8d5fa5afd262889ee9af2f0243a94c6d">Git Tagging</h2>

<p>If the tests pass in <em>scripts</em> only then does <code>shippable</code> go to <strong>after_success</strong> section.
Over there, you might want to tag your source code, so that <code>docker</code> will only pull the tagged and approved commits from <code>shippable</code>, not every commit - which is very important.</p>

<p>Here&rsquo;s how to do that:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">after_success:
  - git tag -f recon_prod master
  - git push -f --tags
</pre></div>


<h1 id="deployment:8d5fa5afd262889ee9af2f0243a94c6d">Deployment</h1>

<p>Once you have approved your code commit, it is time to deploy it to <code>docker</code> on <code>beanstalk</code>.
I like to keep deployment scripts in another bash script, so that deployment can be done in various other ways as well, if needed.</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">after_success:
  - main/scripts/deploy.sh 
  - <span style="color: #204a87">echo</span> <span style="color: #4e9a06">&#39;CODE DEPLOYED&#39;</span>
</pre></div>


<p>Or, you may choose to have the &ldquo;deployment&rdquo; script from another project, if you wish. It allows you to separately maintain all the moving parts.</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">rm -rf <span style="color: #204a87">cd</span> eb-reconwise
<span style="color: #204a87">echo</span> <span style="color: #4e9a06">&#39;Deploying New Dockers&#39;</span>
git clone https://github.com/abhi1010/deplyment_project.git
<span style="color: #204a87">cd</span> deplyment_project/
chmod +x deploy.sh
eb use beanstalk_env_name
./deploy.sh
<span style="color: #204a87">echo</span> <span style="color: #4e9a06">&#39;Deployment Complete&#39;</span>
</pre></div>


<h2 id="dockerfile:8d5fa5afd262889ee9af2f0243a94c6d">Dockerfile</h2>

<p>Now first what we need is setting up <code>docker</code> on beanstalk.</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">  FROM abhi1010/base_docker
  MAINTAINER abhi1010 &lt;codersdigest@gmail.com&gt;
  
  ENV DEBIAN_FRONTEND noninteractive
  
  ENV WS <span style="color: #4e9a06">&#39;/ws&#39;</span>
  ENV CURR_HOME <span style="color: #4e9a06">&#39;/root&#39;</span>
  WORKDIR $WS
  
  RUN git clone https://github.com/abhi1010/dockerprj.git <span style="color: #4e9a06">\</span>
   <span style="color: #ce5c00; font-weight: bold">&amp;&amp;</span> . $WS/ve_envs/rwv2/bin/activate <span style="color: #4e9a06">\</span>
   <span style="color: #ce5c00; font-weight: bold">&amp;&amp;</span> $WS/prj/rw/manage.py collectstatic --noinput
  
  COPY supervisor-app.conf $WS/
  
  RUN <span style="color: #4e9a06">\</span>
      cp $WS/supervisor-app.conf /etc/supervisor/supervisord.conf <span style="color: #4e9a06">\</span>
   <span style="color: #ce5c00; font-weight: bold">&amp;&amp;</span> chown -R www-data:www-data /var/lib/nginx

  VOLUME <span style="color: #ce5c00; font-weight: bold">[</span><span style="color: #4e9a06">&quot;/var/shared/&quot;</span>, <span style="color: #4e9a06">&quot;/etc/nginx/sites-enabled&quot;</span>, <span style="color: #4e9a06">&quot;/var/log/nginx&quot;</span>, <span style="color: #4e9a06">&quot;/ws/&quot;</span><span style="color: #ce5c00; font-weight: bold">]</span>
    
  EXPOSE 80
  CMD <span style="color: #ce5c00; font-weight: bold">[</span><span style="color: #4e9a06">&quot;supervisord&quot;</span>, <span style="color: #4e9a06">&quot;-n&quot;</span><span style="color: #ce5c00; font-weight: bold">]</span>
</pre></div>


<p>This does the following tasks:</p>

<ul>
<li>Run a base <code>docker</code> from a custom image - where all apps and project requirements have already been installed and configured. It helps me save a lot of time during deployments.</li>
<li>Download the source code using <code>RUN</code> - which I update using another method.

<ul>
<li>You can view detail on this <a href="http://abhipandey.com/2015/09/updating-django-source-with-docker-deployments/">method here</a></li>
</ul></li>
<li>Copy the <code>supervisord</code> config as well</li>
<li>Set the right user rights for <code>nginx</code></li>
<li>Setup folders to be shared using <code>VOLUME</code></li>
<li>Expose port 80 so that this <code>docker</code> container can be used as a web container</li>
<li>Set <code>cmd</code> so that it allows <code>supervisord</code> to be used for running the container</li>
</ul>

<h2 id="beanstalk-configuration:8d5fa5afd262889ee9af2f0243a94c6d">Beanstalk Configuration</h2>

<p>Once we have the <code>Dockerfile</code> ready, we need to set up the configuration for <code>beanstalk</code> so that during deployment, other steps can be taken care of as well. Some of the things to keep in mind in <code>beanstalk</code> setup are:</p>

<h3 id="tips:8d5fa5afd262889ee9af2f0243a94c6d">Tips</h3>

<ul>
<li>All <code>beanstalk</code> configuration has be kept in a folder called <strong><code>.ebextension</code></strong><br /></li>
<li><code>beanstalk ec2</code> instance maintains a folder internally to run the scripts while setting up <code>docker</code> for you so that the instance can be ready for you

<ul>
<li>It is totally possible to <em>plug</em> your own scripts into <code>beanstalk</code> initialization setup so that you can <em>program</em> a custom <code>EC2</code> instance for yourself</li>
<li>Folder to place your scripts are <code>/opt/elasticbeanstalk/hooks/appdeploy/post</code> and <code>/opt/elasticbeanstalk/hooks/appdeploy/pre</code></li>
<li>Scripts placed in the folders are read in alphabetical order</li>
</ul></li>
<li>You can increase the timeout of your <code>docker</code> initialization setup if it takes too long due to multiple steps
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000000">option_settings</span><span style="color: #000000; font-weight: bold">:</span>
    <span style="color: #ce5c00; font-weight: bold">-</span> <span style="color: #000000">namespace</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000">aws</span><span style="color: #000000; font-weight: bold">:</span><span style="color: #000000">elasticbeanstalk</span><span style="color: #000000; font-weight: bold">:</span><span style="color: #000000">command</span>
      <span style="color: #000000">option_name</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #000000">Timeout</span>
      <span style="color: #000000">value</span><span style="color: #000000; font-weight: bold">:</span> <span style="color: #0000cf; font-weight: bold">1800</span>
</pre></div>
</li>
</ul>

<h3 id="user-accounts:8d5fa5afd262889ee9af2f0243a94c6d">User Accounts</h3>

<ul>
<li>You can also add any user account if you&rsquo;d like pragmatically and make sure they are <em>always</em> part of the <code>EC2</code> instance that you are creating

<ul>
<li>Create a file called <code>00001.ftp.config</code></li>
<li>Use <code>pre</code> folder to setup accounts</li>
</ul></li>
</ul>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">files:
  <span style="color: #4e9a06">&quot;/opt/elasticbeanstalk/hooks/appdeploy/pre/0001_create_users.sh&quot;</span>:
    mode: <span style="color: #4e9a06">&quot;000755&quot;</span> 
    owner: root
    group: root
    content: <span style="color: #000000; font-weight: bold">|</span>
      <span style="color: #8f5902; font-style: italic">#!/usr/bin/env bash</span>
      <span style="color: #204a87">echo</span> <span style="color: #4e9a06">&#39;About to Add user gh-user&#39;</span>
      adduser gh-user
      runuser -l gh-user -c <span style="color: #4e9a06">&#39;mkdir ~/.ssh&#39;</span>
      runuser -l gh-user -c <span style="color: #4e9a06">&#39;chmod 700 ~/.ssh&#39;</span>
      runuser -l gh-user -c <span style="color: #4e9a06">&#39;touch ~/.ssh/authorized_keys&#39;</span>
      runuser -l gh-user -c <span style="color: #4e9a06">&#39;chmod 600 ~/.ssh/authorized_keys&#39;</span>
      runuser -l gh-user -c <span style="color: #4e9a06">&#39;echo &quot;ssh-rsa r4CBI2cWQohEwBkGw9CcW0vWfnlAcKkrCnsJvwe/+kG5w9J8gJdnNQ8BFB+q+kQ6fWl+1kw7b+8jah5q0nNpOzLbed+Rzse1BoOIjsSXqN/L7AW8y61PVBULcVAVBKCrVy0U5zifv/e6a5+dsUD3WLiD3yXTgPDcZoqQqPYkurCx5ZzxLylKfXfL37k7sz00e+Tu/Y+J9xXdI9j3G5bU9rmIe4SH4mK4BCMRQ6zCHqAzAXZtnmN5U1XR3XrfMtuDLvVgcOlEpXIMl9q2kco0ZCdMkYoSzf3Yj&quot; &gt;&gt; ~/.ssh/authorized_keys&#39;</span>
</pre></div>


<h3 id="pre-installing-packages:8d5fa5afd262889ee9af2f0243a94c6d">Pre-installing Packages</h3>

<ul>
<li>You should also install any package that you&rsquo;d like on all <code>EC2</code> instances</li>
</ul>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">files:
  <span style="color: #4e9a06">&quot;/opt/elasticbeanstalk/hooks/appdeploy/pre/0003_packages.sh&quot;</span>:
    mode: <span style="color: #4e9a06">&quot;000755&quot;</span> 
    owner: root
    group: root
    content: <span style="color: #000000; font-weight: bold">|</span>
      <span style="color: #8f5902; font-style: italic">#!/usr/bin/env bash </span>
      yum install -y git
     
</pre></div>


<h3 id="sharing-volumes-between-docker-and-ec2:8d5fa5afd262889ee9af2f0243a94c6d">Sharing volumes between <code>docker</code> and <code>EC2</code></h3>

<ul>
<li>Ensure that folder sharing is enabled between <code>EC2</code> and <code>docker</code> instances

<ul>
<li>This goes into file <code>Dockerrun.aws.json</code></li>
</ul></li>
</ul>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #ce5c00; font-weight: bold">{</span>
   <span style="color: #4e9a06">&quot;AWSEBDockerrunVersion&quot;</span>: <span style="color: #4e9a06">&quot;1&quot;</span>,
  <span style="color: #4e9a06">&quot;Volumes&quot;</span>: <span style="color: #ce5c00; font-weight: bold">[</span>
    <span style="color: #ce5c00; font-weight: bold">{</span>
      <span style="color: #4e9a06">&quot;HostDirectory&quot;</span>: <span style="color: #4e9a06">&quot;/var/shared&quot;</span>,
      <span style="color: #4e9a06">&quot;ContainerDirectory&quot;</span>: <span style="color: #4e9a06">&quot;/var/shared&quot;</span>
    <span style="color: #ce5c00; font-weight: bold">}</span>
  <span style="color: #ce5c00; font-weight: bold">]</span>,
  <span style="color: #4e9a06">&quot;Ports&quot;</span>: <span style="color: #ce5c00; font-weight: bold">[</span>
    <span style="color: #ce5c00; font-weight: bold">{</span>
      <span style="color: #4e9a06">&quot;ContainerPort&quot;</span>: <span style="color: #4e9a06">&quot;80&quot;</span>
    <span style="color: #ce5c00; font-weight: bold">}</span>
  <span style="color: #ce5c00; font-weight: bold">]</span>,
   <span style="color: #4e9a06">&quot;Logging&quot;</span>: <span style="color: #4e9a06">&quot;/var/log/&quot;</span>
 <span style="color: #ce5c00; font-weight: bold">}</span>
</pre></div>


<h3 id="folder-and-files-structure:8d5fa5afd262889ee9af2f0243a94c6d">Folder and files structure</h3>

<ul>
<li>Finally, make sure that your folder files are setup as follows:</li>
</ul>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">$ <span style="color: #ce5c00; font-weight: bold">(</span>master<span style="color: #ce5c00; font-weight: bold">)</span> tree -a 
.
<span style="color: #000000; font-weight: bold">|</span>-- .ebextensions
<span style="color: #000000; font-weight: bold">|</span>   <span style="color: #000000; font-weight: bold">|</span>-- 0000_users.config  <span style="color: #8f5902; font-style: italic"># setup extra users</span>
<span style="color: #000000; font-weight: bold">|</span>   <span style="color: #000000; font-weight: bold">|</span>-- 0002_packages.config  <span style="color: #8f5902; font-style: italic"># install external packages</span>
<span style="color: #000000; font-weight: bold">|</span>   <span style="color: #000000; font-weight: bold">|</span>-- 0004_bash.config  <span style="color: #8f5902; font-style: italic"># I like to manage all </span>
<span style="color: #000000; font-weight: bold">|</span>-- .elasticbeanstalk
<span style="color: #000000; font-weight: bold">|</span>   <span style="color: #000000; font-weight: bold">|</span>-- config.yml  <span style="color: #8f5902; font-style: italic"># AWS connection details</span>
<span style="color: #000000; font-weight: bold">|</span>-- .gitignore 
<span style="color: #000000; font-weight: bold">|</span>-- Dockerfile  <span style="color: #8f5902; font-style: italic"># Docker instance</span>
<span style="color: #000000; font-weight: bold">|</span>-- Dockerrun.aws.json   <span style="color: #8f5902; font-style: italic"># folder sharing</span>
<span style="color: #000000; font-weight: bold">|</span>-- updater.sh  <span style="color: #8f5902; font-style: italic"># script to update any code</span>
</pre></div>


<h3 id="elasticbeanstalk-folder-for-aws-configs:8d5fa5afd262889ee9af2f0243a94c6d"><code>.elasticbeanstalk</code> folder for <code>aws</code> configs</h3>

<ul>
<li>You might be wondering what&rsquo;s <code>.elasticbeanstalk</code> folder. It is the folder that&rsquo;s responsible for taking your <code>AWS</code> secret key and access id for doing the actual deployment. If you don&rsquo;t set it up, AWS will ask you every time.

<ul>
<li>For setting it up, you just need to call <code>eb config</code> one time, it creates the folder for you with all the details, including connection details. You can then make it part of your <code>git</code> commits</li>
<li>Make sure it is secure</li>
</ul></li>
</ul>

<p>And that&rsquo;s it! Once you commit your code, <code>shippable</code> will run the tests, tag your code and finally download this <em>deployment</em> project and deploy it to <code>beanstalk</code> through <code>docker</code> containers.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2015/09/nginx-upload-limits-on-beanstalk-docker/">Nginx Upload limits on Beanstalk Docker</a>
      </h1>
      <span class="post-date">Sep 4, 2015  &middot; <a href="http://abhipandey.com/2015/09/nginx-upload-limits-on-beanstalk-docker/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/code">code</a><a class="a_cat" href="http://abhipandey.com/categories/continuous-delivery">continuous delivery</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/nginx">nginx</a><a class="a_tag" href="http://abhipandey.com/tags/beanstalk">beanstalk</a><a class="a_tag" href="http://abhipandey.com/tags/docker">docker</a>
    
      </span>
      
      <p>If I am not wrong, <code>nginx</code> only allows you to upload up till max 2Mb of data by default. If you are doing a <code>docker</code> deployment on <code>beanstalk</code> you may to remember to change that not once but twice!</p>

<p>As you may know already, <code>beanstalk</code> creates an <code>EC2</code> instance to manage the <code>docker</code> environment.<br />
Since <code>EC2</code> needs to manage the <code>docker</code> environment and serve the web interface as well, it does so by having another <code>nginx</code> instance to serve the <code>nginx</code> within <code>docker</code>.
Hence, if you had to modify the <code>nginx</code> settings to allow bigger uploads, <strong>you&rsquo;d have to modify the settings for <code>nginx</code> on both - <code>docker</code> as well as <code>EC2</code></strong>.</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">    <span style="color: #8f5902; font-style: italic"># max upload size</span>
    <span style="color: #000000">client_max_body_size</span> <span style="color: #0000cf; font-weight: bold">10</span><span style="color: #000000">M</span><span style="color: #000000; font-weight: bold">;</span>   <span style="color: #8f5902; font-style: italic"># adjust to your liking</span>
</pre></div>


<p>Also, if you don&rsquo;t want to have any limit at all for uploads, then just change the <code>client_max_body_size</code> to 0.</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">    <span style="color: #8f5902; font-style: italic"># max upload size</span>
    <span style="color: #000000">client_max_body_size</span> <span style="color: #0000cf; font-weight: bold">0</span><span style="color: #000000; font-weight: bold">;</span>
</pre></div>


      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2015/09/updating-django-source-with-docker-deployments/">Updating Django Source with Docker Deployments</a>
      </h1>
      <span class="post-date">Sep 4, 2015  &middot; <a href="http://abhipandey.com/2015/09/updating-django-source-with-docker-deployments/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/code">code</a><a class="a_cat" href="http://abhipandey.com/categories/continuous-delivery">continuous delivery</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/docker">docker</a><a class="a_tag" href="http://abhipandey.com/tags/django">django</a><a class="a_tag" href="http://abhipandey.com/tags/uwsgi">uwsgi</a><a class="a_tag" href="http://abhipandey.com/tags/git">git</a><a class="a_tag" href="http://abhipandey.com/tags/supervisord">supervisord</a>
    
      </span>
      
      

<p>While deploying docker multiple times, you may not want to copy over your <code>Django</code> source code every time you do a deployment.</p>

<h1 id="setting-up-supervisord:8ef139736ad377184214844940ced19b">Setting up <code>supervisord</code></h1>

<p>Luckily there is an easy way to manage this. Since you are working with <code>Django</code>, there is a good chance that you are also managing the processes (like <code>uwsgi</code>) with <code>supervisord</code>.</p>

<p>Here are some of the steps that you can take with <code>supervisord</code></p>

<ul>
<li>Set up a new process in <code>supervisord</code></li>
<li>Do not allow it to <em><code>autorestart</code></em> since it will be a one-shot process</li>
<li>Call another script in any format to update the source code

<ul>
<li>As an example, I use <code>bash</code> to update my source code through <code>git</code></li>
</ul></li>
</ul>

<p>Here&rsquo;s a sample code:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">    <span style="color: #ce5c00; font-weight: bold">[</span>program:source-updater<span style="color: #ce5c00; font-weight: bold">]</span>
    <span style="color: #000000">redirect_stderr</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #204a87">true</span>
    <span style="color: #000000">stdout_logfile</span> <span style="color: #ce5c00; font-weight: bold">=</span> /shared/source_code_updater.log
    <span style="color: #000000">directory</span> <span style="color: #ce5c00; font-weight: bold">=</span> /ws/
    <span style="color: #204a87">command</span> <span style="color: #ce5c00; font-weight: bold">=</span> /ws/source_code_updater.sh
    <span style="color: #000000">autorestart</span><span style="color: #ce5c00; font-weight: bold">=</span>False
</pre></div>


<h1 id="updating-the-source-code:8ef139736ad377184214844940ced19b">Updating the source code</h1>

<p>Few things are important to note in a <code>docker</code> deployment:</p>

<ul>
<li>Not every commit needs to be deployed</li>
<li>Filter your commits to only allow <strong><em>deployable</em></strong> code to be updated on <code>docker</code></li>
<li>Include regression, unit and system tests to be part of your build process</li>
<li>Once everything has been confirmed to be working, tag your code so that you know it is worthy of going to docker</li>
<li>Another way would be to manage this process through branches and merge only if everything passes</li>
<li><code>docker</code> deployments would build off this merged branch or tagged version</li>
<li>This way even if you have made 10 commits while fixing a bug and are still in the process of fixing it, you know it won&rsquo;t go to <code>docker</code> deployment</li>
</ul>

<p>With that idea, do a checkout and update the source code according to specific tag:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">    git checkout -f tags/your_tag_name
    git pull origin tags/your_tag_name
</pre></div>


<h1 id="telling-uwsgi-about-the-updated-source-code:8ef139736ad377184214844940ced19b">Telling <code>uwsgi</code> about the updated source code</h1>

<p>Once you have updated your source code, you need to re-load the project onto <code>uwsgi</code> so that <code>nginx</code> or <code>apache</code> can pick it up.
The simplest way to achieve it using the config parameter of <code>uwsgi</code>: <code>--touch-reload</code>. It will <em>reload uWSGI if the specified file is modified/touched</em></p>

<p>Just remember to setup <code>supervisord</code> in your <code>Dockerfile</code> with this config parameter.</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #ce5c00; font-weight: bold">[</span>program:app-uwsgi<span style="color: #ce5c00; font-weight: bold">]</span>
<span style="color: #000000">redirect_stderr</span> <span style="color: #ce5c00; font-weight: bold">=</span> <span style="color: #204a87">true</span>
<span style="color: #000000">stdout_logfile</span> <span style="color: #ce5c00; font-weight: bold">=</span> /var/shared/_uwsgi.log
<span style="color: #204a87">command</span> <span style="color: #ce5c00; font-weight: bold">=</span> /ws/ve_envs/rwv2/bin/uwsgi --touch-reload<span style="color: #ce5c00; font-weight: bold">=</span>/ws/wsgi.ini --ini /ws/wsgi.ini
</pre></div>


<p>You can choose any file. I choose <code>uwsgi.ini</code> because the contents never really need to change in it.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2015/09/multiple-virtual-environments-in-docker/">Multiple Virtual Environments in Docker</a>
      </h1>
      <span class="post-date">Sep 3, 2015  &middot; <a href="http://abhipandey.com/2015/09/multiple-virtual-environments-in-docker/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/continuous-delivery">continuous delivery</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/docker">docker</a><a class="a_tag" href="http://abhipandey.com/tags/python">python</a><a class="a_tag" href="http://abhipandey.com/tags/deployment">deployment</a><a class="a_tag" href="http://abhipandey.com/tags/supervisord">supervisord</a>
    
      </span>
      
      <p>It may seem like a daunting task to have multiple python projects running in their own virtual environments in docker as you want to manage the running of the tasks from a single source - let&rsquo;s say <code>supervisord</code>.
However, all that is required here is to know that python automatically picks up the location of the virtual environments if you provide full path to the virtual environment&rsquo;s python.</p>

<p>For example, in my docker environment, I have virtual environment install at the following location:</p>

<pre><code>/ws/ve_envs/rwv1/
</code></pre>

<p>To enable a project with this virtual environment, I can run the following:</p>

<pre><code>/ws/ve_envs/rwv1/bin/python3.4 PYTHON_PROJECT_FILE_TO_RUN.py
</code></pre>

<p>Similarly, other projects can be set up in the same way.</p>

<p>For example, for running <code>uwsgi</code> I provide the full path for python as follows:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #ce5c00; font-weight: bold">[</span>program:appName<span style="color: #ce5c00; font-weight: bold">]</span>
<span style="color: #000000">stdout_logfile</span> <span style="color: #ce5c00; font-weight: bold">=</span> /var/shared/_uwsgi.log
<span style="color: #204a87">command</span> <span style="color: #ce5c00; font-weight: bold">=</span> /ws/ve_envs/project/bin/uwsgi --touch-reload<span style="color: #ce5c00; font-weight: bold">=</span>/ws/wsgi.ini --ini /ws/wsgi.ini
</pre></div>


<p>You might want to read about <code>--touch-reload</code> in my <a href="http://abhipandey.com/2015/09/updating-django-source-with-docker-deployments/">other post.</a></p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2015/08/sharing-folders-on-beanstalk-docker/">Sharing folders on Beanstalk Docker</a>
      </h1>
      <span class="post-date">Aug 14, 2015  &middot; <a href="http://abhipandey.com/2015/08/sharing-folders-on-beanstalk-docker/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/code">code</a><a class="a_cat" href="http://abhipandey.com/categories/continuous-delivery">continuous delivery</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/docker">docker</a><a class="a_tag" href="http://abhipandey.com/tags/nginx">nginx</a><a class="a_tag" href="http://abhipandey.com/tags/aws">aws</a><a class="a_tag" href="http://abhipandey.com/tags/beanstalk">beanstalk</a>
    
      </span>
      
      <p>It is very easy to setup volume sharing in <code>docker</code>. You ideally want the following folders to be shared when a new <code>docker</code> is initialized for you:</p>

<ul>
<li><code>/var/log</code> so that you can keep track of logs</li>
<li><code>nginx</code> specific folders because you will have two instances of <code>nginx</code> running - one on <code>docker</code> and another on <code>EC2</code>. This allows you to share logs

<ul>
<li>Also read <a href="http://abhipandey.com/2015/09/nginx-upload-limits-on-beanstalk-docker/">this post</a> for related info</li>
</ul></li>
<li>your personal workspace or anything that you&rsquo;d like to share</li>
</ul>

<p>Here&rsquo;s how you&rsquo;d do it. The keyword is <code>VOLUME</code>&hellip; in your <code>Dockerfile</code></p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000000">VOLUME</span> <span style="color: #000000; font-weight: bold">[</span> \
    <span style="color: #4e9a06">&quot;/var/shared/&quot;</span><span style="color: #000000; font-weight: bold">,</span> \ 
    <span style="color: #4e9a06">&quot;/etc/nginx/sites-enabled&quot;</span><span style="color: #000000; font-weight: bold">,</span> \ 
    <span style="color: #4e9a06">&quot;/var/log/nginx&quot;</span><span style="color: #000000; font-weight: bold">,</span> \
    <span style="color: #4e9a06">&quot;/ws/&quot;</span> \
<span style="color: #000000; font-weight: bold">]</span>
</pre></div>


      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2015/08/convert-github-wiki-to-static-site-with-themes/">Convert GitHub Wiki to Static Site with themes</a>
      </h1>
      <span class="post-date">Aug 7, 2015  &middot; <a href="http://abhipandey.com/2015/08/convert-github-wiki-to-static-site-with-themes/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/tips">tips</a><a class="a_cat" href="http://abhipandey.com/categories/code">code</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/github">github</a><a class="a_tag" href="http://abhipandey.com/tags/wiki">wiki</a><a class="a_tag" href="http://abhipandey.com/tags/pelican">pelican</a>
    
      </span>
      
      

<p>I recently wanted to setup a wiki so that I could convert it into a static html site with a proper themes.
What could be a possible use case for such a requirement:</p>

<ul>
<li>Manage the documentation of a product internally through <code>git</code> but publish it for clients/world through static site</li>
<li>Convert the uncolored wiki to a themed version</li>
<li>Allow serving of the wiki through web application frameworks like <code>Django</code>

<ul>
<li>It may allow you to have authentication system as a first step hurdle to stop everybody from giving access</li>
</ul></li>
</ul>

<p>Anyways, I went about the whole process and decided to jot down everything. Here I am taking <a href="https://github.com/mbostock/d3/wiki">D3 Wiki</a> as an example
which I will be converting into a static site. Let&rsquo;s begin.</p>


<figure >
    
        <img src="/images/wiki_to_static_1.png" alt="D3 Wiki using pelican" />
    
    
    <figcaption>
        <p>
        D3 Wiki using pelican
        
            
        
        </p> 
    </figcaption>
    
</figure>


<h1 id="setup-and-requirements:7286face6d57cb9f253b611714e09c9a">Setup and requirements</h1>

<p>What do we need to get started?</p>

<ul>
<li>We will need a static site generator

<ul>
<li>Let&rsquo;s use <a href="http://blog.getpelican.com"><code>pelican</code></a> for this demo</li>
</ul></li>
<li>An actual wiki

<ul>
<li>Since we are going to demo how to convert a wiki to static we will use an
<a href="https://github.com/showcases/projects-with-great-wikis">existing wiki from github</a></li>
<li>Let&rsquo;s choose <a href="https://github.com/mbostock/d3/wiki">D3 Wiki</a> for this instance</li>
</ul></li>
<li>Python environment so that <em>pelican</em> and <em>fabric</em> can be installed</li>
</ul>

<h2 id="virtual-environment-with-pelican:7286face6d57cb9f253b611714e09c9a">Virtual Environment with pelican</h2>

<p><strong>Setup the virtual environment</strong></p>

<pre><code class="language-bash">$ virtualenv ve_blog
$ source ve_blog/bin/activate
</code></pre>

<p><strong>Install pelican</strong></p>

<pre><code>$ pip install pelican
</code></pre>

<p><strong>Pelican Quickstart</strong></p>

<p>Setup pelican using <code>pelican-quickstart</code> so that all files are setup correctly for creating a static site.</p>

<pre><code class="language-bash">$ pelican-quickstart

Welcome to pelican-quickstart v3.6.3.

This script will help you create a new Pelican-based website.

Please answer the following questions so this script can generate the files
needed by Pelican.

    
&gt; Where do you want to create your new web site? [.] 
&gt; What will be the title of this web site? D3 WIKI
&gt; Who will be the author of this web site? abhi1010
&gt; What will be the default language of this web site? [en] 
&gt; Do you want to specify a URL prefix? e.g., http://example.com   (Y/n) n
&gt; Do you want to enable article pagination? (Y/n) Y
&gt; How many articles per page do you want? [10] 
&gt; What is your time zone? [Europe/Paris] Asia/Singapore
&gt; Do you want to generate a Fabfile/Makefile to automate generation and publishing? (Y/n) Y
&gt; Do you want an auto-reload &amp; simpleHTTP script to assist with theme and site development? (Y/n) Y
&gt; Do you want to upload your website using FTP? (y/N) N
&gt; Do you want to upload your website using SSH? (y/N) N
&gt; Do you want to upload your website using Dropbox? (y/N) N
&gt; Do you want to upload your website using S3? (y/N) N
&gt; Do you want to upload your website using Rackspace Cloud Files? (y/N) N
&gt; Do you want to upload your website using GitHub Pages? (y/N) N
Done. Your new project is available at /Users/apandey/code/githubs/d3wiki
</code></pre>

<h2 id="get-the-wiki:7286face6d57cb9f253b611714e09c9a">Get the wiki</h2>

<pre><code class="language-bash">$ git clone https://github.com/mbostock/d3.wiki.git

Cloning into 'd3.wiki'...
remote: Counting objects: 12026, done.
remote: Compressing objects: 100% (67/67), done.
remote: Total 12026 (delta 607), reused 552 (delta 552), pack-reused 11407
Receiving objects: 100% (12026/12026), 9.92 MiB | 1.49 MiB/s, done.
Resolving deltas: 100% (7595/7595), done.
Checking connectivity... done.
</code></pre>

<p><strong>Setting the wiki as content for pelican</strong></p>

<pre><code class="language-bash">$ rmdir content
$ ln -s dr.wiki content
</code></pre>

<h1 id="why-simple-pelican-won-t-work-and-what-to-do:7286face6d57cb9f253b611714e09c9a">Why simple pelican won&rsquo;t work and what to do</h1>

<p>If you tried to simply call <code>pelican</code> command to build the static site, you will notice a lot of errors like:</p>

<pre><code class="language-bash">
$ fab build

RROR: Skipping ./请求.md: could not find information about 'NameError: title'
ERROR: Skipping ./过渡.md: could not find information about 'NameError: title'
ERROR: Skipping ./选择器.md: could not find information about 'NameError: title'
ERROR: Skipping ./选择集.md: could not find information about 'NameError: title'
Done: Processed 0 articles, 0 drafts, 0 pages and 0 hidden pages in 3.47 seconds.
</code></pre>

<p>The problem is that pelican expects some variables to be defined in each <em>markdown</em> file before it can build the static file.
 Some of the variables are:</p>

<ul>
<li>Title</li>
<li>Slug</li>
<li>Date</li>
</ul>

<p>You may add your own <a href="http://docs.getpelican.com/en/3.6.3/content.html#file-metadata">ones as well</a> that you want.
 However, for our initial purposes, we will keep it simple and just try to add these.</p>

<p><strong>Next</strong>, how do we achieve this automation?
<strong><code>fab</code> is our answer.</strong></p>

<p>Let&rsquo;s write a function in python that will modify the markdown files and update them to add <em>Title, Slug, Date</em></p>

<p>We will edit <code>fabfile.py</code> and add a new function <code>create_wiki</code>:</p>

<pre><code>def create_wiki():
    files = []
    # Find all markdown files in content folder 
    for f in os.walk('./content/'):
        fpath = lambda x: os.path.join(f[0], x)
        for file in f[2]:
            fullpath = fpath(file)
            # print('f = {}'.format(fullpath))
            files.append(fullpath)
    filtered = [f for f in files if f.endswith('.md')]
    for file in filtered:
        with open(file, 'r+') as f:
            content = f.read()
            f.seek(0, 0)
            base = os.path.basename(file).replace('.md', '') 
            lines = ['Title: {}'.format(base.replace('-', ' ')),
                    'Slug: {}'.format(base),
                    'Date: 2015-08-07T14:59:18-04:00',
                    '', '']
            line = '\n'.join(lines)
            # Add the lines to the file
            f.write(line + '\n' + content)
        print(file)
    
    # build and serve the website
    build()
    serve()
</code></pre>

<p>Now you can call this function easily:</p>

<pre><code>fab create_wiki
</code></pre>

<p>The website can now be viewed at <a href="http://localhost:8000">http://localhost:8000</a></p>

<h1 id="what-happened-to-the-menu:7286face6d57cb9f253b611714e09c9a">What happened to the menu?</h1>

<p>There is a minor issue here though, you will notice that the menu is not available - it is all empty.
It is an easy addition. We will need to add some lines to <code>publishconf.py</code> to say what the menu is gonna be.</p>

<p>For my example, I have chosen to show up the following for <em>D3</em>:</p>

<ul>
<li>API Reference</li>
<li>Tutorials</li>
<li>Plugins</li>
</ul>

<pre><code class="language-python"># We don't want all pages to show up in menu
DISPLAY_PAGES_ON_MENU = False

# Choose the specific pages that should be part of menu
MENUITEMS = ( 
    ('HOME', '/home.html'),
    ('API Reference', '/API-Reference.html'),
    ('Tutorials', '/Tutorials.html'),
    ('Plugins', '/Plugins.html'),
)
</code></pre>

<h1 id="choosing-themes:7286face6d57cb9f253b611714e09c9a">Choosing themes</h1>

<p>By default, pelican uses its own theme for the static site, but theme can be modified.
Let&rsquo;s choose <code>pelican bootstrap3</code> for our example here:</p>

<pre><code>git clone https://github.com/DandyDev/pelican-bootstrap3.git
</code></pre>

<p>Now, add the full path to the theme at the end of the <code>publishconf.py</code> file:</p>

<pre><code>THEME = &quot;/Users/apandey/code/githubs/pelican_coders/all_themes/pelican-bootstrap3&quot;
</code></pre>

<p>Finally, build your site again and serve:</p>

<pre><code>fab build
fab serve
</code></pre>


<figure >
    
        <img src="/images/wiki_to_static_2.png" alt="Pelican Bootstrap3 theme" />
    
    
    <figcaption>
        <p>
        Pelican Bootstrap3 theme
        
            
        
        </p> 
    </figcaption>
    
</figure>


<h1 id="get-all-this-code-in-github-repo:7286face6d57cb9f253b611714e09c9a">Get all this code in github repo</h1>

<p>I realize there maybe a few things going on here. You can get this whole setup as a project from
my <a href="https://github.com/abhi1010/d3wiki">github repo</a></p>

<p>You will find all this code and setup so that your life is easier. Just start with d3 wiki along with virtual environment and you will be fine.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2015/08/docker-container-cleanup-on-elastic-beanstalk/">Docker Container cleanup on Elastic Beanstalk</a>
      </h1>
      <span class="post-date">Aug 7, 2015  &middot; <a href="http://abhipandey.com/2015/08/docker-container-cleanup-on-elastic-beanstalk/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/continuous-delivery">continuous delivery</a><a class="a_cat" href="http://abhipandey.com/categories/code">code</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/aws">aws</a><a class="a_tag" href="http://abhipandey.com/tags/beanstalk">beanstalk</a><a class="a_tag" href="http://abhipandey.com/tags/docker">docker</a>
    
      </span>
      
      

<p>Sometimes you may notice that old containers are not cleaned up from Beanstalk environment. This may be due to your container still running as a ghost on the background. One way to find out about this is to quickly look into your
<code>/var/lib/docker/vfs/dir</code> directory whether it has too many folders.</p>

<p>Next, find out what container processes you have going on.
<code>[root@ip dir]# docker ps -a</code></p>

<p>You might see something like this:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000000; font-style: italic">    CONTAINER ID        IMAGE                              COMMAND             CREATED             STATUS              PORTS               NAMES</span>
<span style="color: #000000; font-style: italic">    1611e5ebe2c0        aws_beanstalk/staging-app:latest   &quot;supervisord -n&quot;    About an hour ago                                           boring_galileo</span>
<span style="color: #000000; font-style: italic">    e59d0dd8bba1        aws_beanstalk/staging-app:latest   &quot;supervisord -n&quot;    About an hour ago                                           desperate_yalow</span>
<span style="color: #000000; font-style: italic">    3844d0e18c47        aws_beanstalk/staging-app:latest   &quot;supervisord -n&quot;    2 hours ago         Up 8 minutes        80/tcp              pensive_jang</span>
</pre></div>


<p>Ideally, we want to &ldquo;forcibly remove&rdquo; all images (and hence the folders from <code>/var/lib/docker/vfs/dir</code> directory) that are not in use anymore.
Just run the following to test whether it works:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000000; font-style: italic">    docker rmi -f `docker images -aq`</span>
</pre></div>


<p>You might run into trouble where docker says that all those images already have a container that is running them. This means those container are orphaned but not killed as we thought them to be. Let&rsquo;s remove the shared volumes if any, for each one of them.</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000000; font-style: italic">    docker rm -fv `docker ps -aq` </span>
</pre></div>


<p>This will</p>

<ul>
<li>kill the container</li>
<li>unlink the volumes</li>
</ul>

<p>You should see a lot more space now on your beanstalk instance.
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000000; font-style: italic">    [root@ip dir]# df -h</span>
<span style="color: #000000; font-style: italic">    Filesystem      Size  Used Avail Use% Mounted on</span>
<span style="color: #000000; font-style: italic">    /dev/xvda1      7.8G  1.8G  5.9G  24% /</span>
<span style="color: #000000; font-style: italic">    devtmpfs        490M   96K  490M   1% /dev</span>
<span style="color: #000000; font-style: italic">    tmpfs           499M     0  499M   0% /dev/shm</span>
</pre></div>
</p>

<h1 id="last-resort:57533ab22b2cfb33b4a75f9cd178e950">Last Resort</h1>

<p>If you feel that all this is not working, then you can try one of the scripts provided by <code>docker</code> itself at
<a href="https://github.com/docker/docker/blob/master/contrib/nuke-graph-directory.sh">GitHub</a></p>

<p>It will delete the folders under <code>/var/lib/docker</code> and try to do it responsibly.</p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2014/06/partition-linked-list-around-a-value-x/">Partition Linked List around a Value X</a>
      </h1>
      <span class="post-date">Jun 9, 2014  &middot; <a href="http://abhipandey.com/2014/06/partition-linked-list-around-a-value-x/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/code">code</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/c">c&#43;&#43;</a><a class="a_tag" href="http://abhipandey.com/tags/algo">algo</a><a class="a_tag" href="http://abhipandey.com/tags/linked-list">linked list</a>
    
      </span>
      
      

<p>How do you partition a list around a value x, such that all nodes less than x come before all nodes greater than or equal to x?</p>

<p>Well, there are some solutions possible. The solution, I came up with, is a bit convoluted but let me tell the idea behind it. You want to track the following:</p>

<ul>
<li><p>Two pointers to remember the beginning of the <em>lower</em> and <em>higher</em> series each</p></li>

<li><p>One pointer (<em>current</em>) to iterate through the Linked List</p></li>

<li><p>The list may itself start with higher or lower value compared to the <em>middleValue</em>. Thus we need to remember the beginning of the lower series (<em>lowerSeries</em>) as this is what we will send back</p></li>
</ul>

<p>Now that we have this out of the way, let&rsquo;s look at the code:</p>

<script type="text/javascript" src="http://gist.github.com/3ada1d15b5bda319a54c.js"></script>

<h1 id="code:8a20b19b0e16e5ac875728276c435d4c">Code</h1>

<p>As usual the code is available <a href="https://github.com/abhi1010/Algorithms/blob/master/Algo_codes/Node.cpp">here</a>:</p>

<p><a href="https://github.com/abhi1010/Algorithms">https://github.com/abhi1010/Algorithms</a></p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2014/06/find-the-kth-to-last-element-of-a-singly-linked-list/">Find the Kth to Last Element of a Singly Linked List</a>
      </h1>
      <span class="post-date">Jun 8, 2014  &middot; <a href="http://abhipandey.com/2014/06/find-the-kth-to-last-element-of-a-singly-linked-list/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/code">code</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/c">c&#43;&#43;</a><a class="a_tag" href="http://abhipandey.com/tags/algo">algo</a><a class="a_tag" href="http://abhipandey.com/tags/linked-list">linked list</a>
    
      </span>
      
      <p>It is possible to a recursive solutions but I will use a simple runner logic. Recursive solutions are usually less optimal.</p>

<p>Note here that, in our logic K=1 would return the last element in the linked list. Similarly, K=2 would return the second last element.</p>

<p>The suggested solution here is to use two pointers:</p>

<ul>
<li>One pointer will first travel K items into the list</li>
<li>Once that is done, both the pointers start travelling together, one item at a time</li>
<li>They keep travelling until the end of linked list is found</li>
<li>In that situation, the first pointer is at the end of the list, but the second pointer would have only reached till Kth element - this is what you want</li>
</ul>

<p>Let&rsquo;s have a look at the code:</p>

<script type="text/javascript" src="http://gist.github.com/43e289a9877fb9293680.js"></script>

<p>As usual the code is available <a href="https://github.com/abhi1010/Algorithms/blob/master/Algo_codes/Node.cpp">here</a>:</p>

<p><a href="https://github.com/abhi1010/Algorithms">https://github.com/abhi1010/Algorithms</a></p>

      
    </div>
    
    <div class="post">
      <h1 class="post-title">
        <a href="http://abhipandey.com/2014/06/removing-duplicates-from-linked-list/">Removing Duplicates from Linked List</a>
      </h1>
      <span class="post-date">Jun 7, 2014  &middot; <a href="http://abhipandey.com/2014/06/removing-duplicates-from-linked-list/#disqus_thread">Comments</a>
      
      <br/>
      <a class="a_cat" href="http://abhipandey.com/categories/code">code</a>
        
      <a class="a_tag" href="http://abhipandey.com/tags/c">c&#43;&#43;</a><a class="a_tag" href="http://abhipandey.com/tags/algo">algo</a><a class="a_tag" href="http://abhipandey.com/tags/linked-list">linked list</a>
    
      </span>
      
      

<p>Duplicates can be removed in many ways:</p>

<ul>
<li><p>Create a new Linked List containing only unique items</p></li>

<li><p>Iterate through the Linked List and keep removing items that are being repeated</p></li>
</ul>

<p>The internal structure itself for the algo can either be map or set based. When using map the Node itself can be saved thereby making your life easier if you are creating a new Linked List. However sets can be very useful if we are just iterating through the Linked List and simply deleting items that are being repetetive. This is also a great spacesaver. Hence we decided to go down this path.</p>

<h1 id="code:33d170712a3b1643edfc33b9f231740c">Code</h1>

<p>As usual the <a href="https://github.com/abhi1010/Algorithms/blob/master/Algo_codes/Node.cpp">code</a> is available here:</p>

<p><a href="https://github.com/abhi1010/Algorithms">https://github.com/abhi1010/Algorithms</a></p>

<p>Here&rsquo;s a small sample as to how to do it:</p>

<script type="text/javascript" src="http://gist.github.com/e2b7117c20d0f591896f.js"></script>

      
    </div>
    
    
    
    <ul class="pagination">
        
        <li>
            <a href="/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
        </li>
        
        <li
        >
        <a href="/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
        </li>
        
        <li
        ><a href="/">1</a></li>
        
        <li
        class="active"><a href="/page/2/">2</a></li>
        
        <li
        ><a href="/page/3/">3</a></li>
        
        <li
        ><a href="/page/4/">4</a></li>
        
        <li
        ><a href="/page/5/">5</a></li>
        
        <li
        ><a href="/page/6/">6</a></li>
        
        <li
        >
        <a href="/page/3/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
        </li>
        
        <li>
            <a href="/page/6/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
        </li>
        
    </ul>
    
  </div>
</div>


<script type="text/javascript">
var disqus_shortname = "abhi1010";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>


</body>
</html>

